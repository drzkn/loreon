#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Obtener la rama actual
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Verificar si se está haciendo push a main
if [ "$current_branch" = "main" ]; then
  echo "🚫 ERROR: No se permite hacer push directo a la rama main"
  echo "💡 Usa un pull request para integrar cambios en main"
  exit 1
fi

# Verificar si hay cambios staged
if git diff --cached --quiet; then
  echo "⚠️  No hay cambios staged, saltando verificación de tests"
  exit 0
fi

echo "🧪 Ejecutando tests antes del push..."

# Ejecutar tests con coverage
npm run test:coverage

# Verificar que los tests pasaron
if [ $? -ne 0 ]; then
  echo "❌ Los tests fallaron. No se permite el push."
  exit 1
fi

# Verificar coverage mínimo del 80%
echo "📊 Verificando coverage mínimo del 80%..."

# Ejecutar vitest con coverage y capturar el output
coverage_output=$(npm run test:coverage 2>&1)

# Extraer el porcentaje de coverage total (líneas)
coverage_percentage=$(echo "$coverage_output" | grep -o 'All files.*|.*|.*|.*|' | awk -F'|' '{print $4}' | tr -d ' %')

# Si no se pudo extraer el porcentaje, usar una verificación alternativa
if [ -z "$coverage_percentage" ]; then
  # Verificar si existe el archivo de coverage JSON
  if [ -f "coverage/coverage-summary.json" ]; then
    # Usar jq para extraer el porcentaje si está disponible
    if command -v jq > /dev/null; then
      coverage_percentage=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
    fi
  fi
fi

# Verificar si el coverage es suficiente
if [ -n "$coverage_percentage" ] && [ "$coverage_percentage" != "null" ]; then
  # Convertir a entero para comparación
  coverage_int=$(echo "$coverage_percentage" | cut -d'.' -f1)
  
  if [ "$coverage_int" -lt 80 ]; then
    echo "❌ Coverage insuficiente: ${coverage_percentage}% (mínimo requerido: 80%)"
    echo "🔍 Ejecuta 'npm run test:coverage' para ver el reporte detallado"
    exit 1
  else
    echo "✅ Coverage suficiente: ${coverage_percentage}%"
  fi
else
  echo "⚠️  No se pudo determinar el porcentaje de coverage exacto"
  echo "🔍 Verifica manualmente ejecutando: npm run test:coverage"
  
  # Verificar que al menos el archivo de coverage existe
  if [ ! -f "coverage/coverage-summary.json" ]; then
    echo "❌ No se generó el reporte de coverage"
    exit 1
  fi
fi

echo "✅ Todas las verificaciones pasaron. Procediendo con el push..." 